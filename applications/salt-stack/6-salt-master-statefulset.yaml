apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: salt-master
spec:
  serviceName: "salt-master"
  replicas: 1
  selector:
    matchLabels:
      app: salt-master
  template:
    metadata:
      labels:
        app: salt-master
    spec:
      volumes:
        - name: salt-config-volume
          emptyDir: {}
      initContainers:
        - name: git-clone-salt-config
          image: alpine/git:latest
          args: [ "clone", "--single-branch", "--", "https://github.com/StephenPendrigh/reclaim-the-stack.git", "/repo" ]
          volumeMounts:
          - name: salt-config-volume
            mountPath: /repo
        - name: create-secret-config
          image: busybox:1.35
          command: ['sh', '-c']
          args:
            - |
              CONFIG_DIR="/repo/applications/salt-stack/saltconfig/etc/master.d"
              mkdir -p ${CONFIG_DIR}

              cat <<EOF > "${CONFIG_DIR}/mysql.conf"
              # This file is auto-generated during pod initialization
              mysql.host: '${DB_HOST}'
              mysql.user: '${DB_USER}'
              mysql.pass: '${DB_PASS}'
              mysql.db: '${DB_NAME}'
              mysql.port: '${DB_PORT}'
              EOF
              echo "Secret Salt config snippet created at ${CONFIG_DIR}/mysql.conf
              sleep 120"
          envFrom:
            - configMapRef:
                name: alcali-config
            - secretRef:
                name: alcali-secrets
          volumeMounts:
          - name: salt-config-volume
            mountPath: /repo
      containers:
        - name: salt-master
          image: salttake3-master:latest # This is a local image I pushed to k3s by running docker save salttake3-master:latest | sudo k3s ctr images import -
          imagePullPolicy: IfNotPresent
          env:
            - name: PYTHONUNBUFFERED
              value: "true"
          ports:
            - containerPort: 8080
            - containerPort: 4505
            - containerPort: 4506
          volumeMounts:
            - name: salt-config-volume
              subPath: applications/salt-stack/saltconfig/etc/salt
              mountPath: /etc/salt

            - name: salt-config-volume
              subPath: applications/salt-stack/saltconfig/srv
              mountPath: /srv
              
            - name: pki-data
              mountPath: /etc/salt/pki
  volumeClaimTemplates:
    - metadata:
        name: pki-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 100Mi
